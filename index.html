<div id="folder-picker-overlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,0.85); z-index:3000; align-items:center; justify-content:center;">
    <div style="background:var(--oxblood); border:2px solid var(--crimson); width:80%; max-width:400px; max-height:70vh; display:flex; flex-direction:column;">
        <div style="padding:15px; border-bottom:1px solid var(--crimson); font-family:'Cinzel'; color:var(--gold); display:flex; justify-content:space-between;">
            <span>SELECT DESTINATION</span>
            <span onclick="closeFolderPicker()" style="cursor:pointer;">âœ•</span>
        </div>
        <div id="picker-list" style="overflow-y:auto; padding:10px;"></div>
        <button class="tool-btn" style="margin:10px; border-style:dashed;" onclick="createNewFolderFromPicker()">+ NEW FOLDER</button>
    </div>
</div>

<script>
    // --- NEW FOLDER PICKER LOGIC ---

    window.openFolders = () => {
        const overlay = document.getElementById('folder-picker-overlay');
        const list = document.getElementById('picker-list');
        list.innerHTML = "";
        overlay.style.display = 'flex';

        // Get all unique folder names currently in the tree
        // We ensure "âš¡ï¸IMPORTANTâš¡ï¸" and "Recent Notes" are always options
        const folders = new Set(["âš¡ï¸IMPORTANTâš¡ï¸", "Recent Notes"]);
        
        // Pull existing folders from the sidebar structure
        document.querySelectorAll('.folder-wrapper').forEach(el => {
            folders.add(el.dataset.folderName);
        });

        folders.forEach(folderName => {
            const item = document.createElement('div');
            item.className = 'sidebar-item';
            item.style.borderBottom = "1px solid rgba(139,0,0,0.2)";
            item.innerHTML = `ðŸ“ ${folderName}`;
            item.onclick = () => {
                currentFolderName = folderName;
                document.getElementById('current-path-display').innerText = "Path: " + folderName;
                closeFolderPicker();
                alert(`Target set to: ${folderName}`);
            };
            list.appendChild(item);
        });
    };

    window.closeFolderPicker = () => {
        document.getElementById('folder-picker-overlay').style.display = 'none';
    };

    window.createNewFolderFromPicker = () => {
        const n = prompt("Enter new folder name:");
        if (n) {
            currentFolderName = n;
            document.getElementById('current-path-display').innerText = "Path: " + n;
            closeFolderPicker();
        }
    };

    // --- REPLACEMENT FOR THE SAVE LOGIC ---
    // Ensure saveQuick uses the currentFolderName set by the picker
    window.saveQuick = () => {
        const noteId = currentEditingId || db.ref('notes').push().key;
        const data = { 
            title: document.getElementById('note-title').value || "Untitled", 
            body: document.getElementById('note-body').innerHTML, 
            folder: currentFolderName, // This is updated by the picker
            timestamp: Date.now(), 
            id: noteId 
        };
        db.ref('notes/' + noteId).set(data).then(() => alert("Sealed in " + currentFolderName));
    };
</script>
