/* --- REPLACING THE insertImg FUNCTION --- */
window.insertImg = (e) => {
    const reader = new FileReader();
    reader.onload = (ev) => {
        // Created with 2x2cm approximate initial size (75px)
        const imgHtml = `<img src="${ev.target.result}" style="width:100%; height:100%; object-fit:cover;">`;
        document.getElementById('note-body').insertAdjacentHTML('beforeend', 
            wrapRelic(imgHtml, "img-relic", "75px", "75px")
        );
    };
    reader.readAsDataURL(e.target.files[0]);
};

/* --- ENHANCED TOUCH ENGINE FOR LONG-PRESS DELETE --- */
document.addEventListener('touchstart', (e) => {
    const target = e.target; 
    const container = target.closest('.relic-container');
    
    if (isLocked) return;
    if (!container) { 
        if (activeRelic) activeRelic.classList.remove('active-relic'); 
        activeRelic = null; 
        return; 
    }

    activeRelic = container; 
    activeRelic.classList.add('active-relic');

    // LONG PRESS TO DELETE LOGIC
    longPressTimer = setTimeout(() => {
        const type = container.classList.contains('img-relic') ? "Image" : "Relic";
        if (confirm(`Do you wish to permanently erase this ${type}?`)) {
            container.remove();
            activeRelic = null;
        }
    }, 800); // 800ms hold for confirmation

    const touch = e.touches[0];
    if (target.classList.contains('drag-handle')) {
        clearTimeout(longPressTimer); // Cancel delete if dragging starts
        isDragging = true; 
        startX = touch.clientX; 
        startY = touch.clientY;
        startL = activeRelic.offsetLeft; 
        startT = activeRelic.offsetTop; 
        e.preventDefault();
    } else if (target.classList.contains('resize-handle')) {
        clearTimeout(longPressTimer); // Cancel delete if resizing starts
        isResizing = true; 
        startX = touch.clientX; 
        startY = touch.clientY;
        startW = activeRelic.offsetWidth; 
        startH = activeRelic.offsetHeight; 
        e.preventDefault();
    }
}, {passive: false});

// Ensure timer clears if finger moves or lifts early
document.addEventListener('touchmove', () => clearTimeout(longPressTimer));
document.addEventListener('touchend', () => clearTimeout(longPressTimer));
