<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0">
    <title>AidenNotes | Universal</title>

    <link rel="apple-touch-icon" href="https://filedn.eu/lmLPHhnmVT38F0vdFViDpAf/Notesapp/aidennotesicon.jpg">
    <link rel="icon" type="image/jpeg" href="https://filedn.eu/lmLPHhnmVT38F0vdFViDpAf/Notesapp/aidennotesicon.jpg">
    
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="AidenNotes">
    <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;700&family=Playfair+Display:ital@0;1&display=swap" rel="stylesheet">
    <style>
        :root { --oxblood: #1a0505; --crimson: #8b0000; --parchment: #f5e6d3; --ink: #0a0a0a; --silver: #a9a9a9; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; }
        html, body { height: 100%; margin: 0; padding: 0; background-color: var(--ink); color: var(--parchment); font-family: 'Playfair Display', serif; overflow: hidden; }
        
        #login-screen { position: fixed; inset: 0; background: radial-gradient(circle, #2a0a0a 0%, #0a0a0a 100%); z-index: 2000; display: flex; align-items: center; justify-content: center; }
        .login-box { background: var(--oxblood); padding: 40px; border: 2px solid var(--crimson); text-align: center; box-shadow: 0 0 20px rgba(139, 0, 0, 0.5); width: 90%; max-width: 400px; }

        .app-container { display: none; height: 100vh; width: 100vw; flex-direction: row; }
        
        #sidebar { width: 260px; background-color: var(--oxblood); border-right: 1px solid var(--crimson); display: flex; flex-direction: column; flex-shrink: 0; overflow-y: auto; }
        .sidebar-item { padding: 12px; cursor: pointer; border-bottom: 1px solid rgba(139,0,0,0.2); font-family: 'Cinzel'; font-size: 0.7rem; display: flex; justify-content: space-between; align-items: center; gap: 5px;}
        .sidebar-item:hover { background: var(--crimson); }
        .folder-content { padding-left: 15px; background: rgba(0,0,0,0.3); display: none; border-left: 2px solid var(--crimson); }
        .actions { display: flex; gap: 8px; opacity: 0.6; }
        .actions span:hover { opacity: 1; color: white; }

        @media (max-width: 600px) {
            .app-container { flex-direction: column; } 
            #sidebar { width: 100%; height: auto; max-height: 200px; border-right: none; border-bottom: 2px solid var(--crimson); }
        }

        #main-editor { flex-grow: 1; display: flex; flex-direction: column; background: radial-gradient(circle at center, #1a0505 0%, #0a0a0a 100%); position: relative; overflow-y: auto; -webkit-overflow-scrolling: touch; }
        .scroll-content { padding: 20px; max-width: 900px; margin: 0 auto; width: 100%; }
        #note-title { width: 100%; background: transparent; border: none; color: var(--crimson); font-family: 'Cinzel'; font-size: 1.8rem; outline: none; margin-bottom: 5px; }
        #current-path-display { font-size: 0.6rem; color: var(--silver); font-family: 'Cinzel'; margin-bottom: 15px; }

        .sub-title-toolbar { display: flex; gap: 6px; flex-wrap: wrap; padding: 10px 0; border-bottom: 1px solid var(--crimson); margin-bottom: 20px; position: sticky; top: 0; background: rgba(10, 10, 10, 0.95); z-index: 10; }
        .tool-btn { background: var(--ink); border: 1px solid var(--crimson); color: var(--parchment); padding: 6px 10px; cursor: pointer; font-family: 'Cinzel'; font-size: 0.7rem; border-radius: 3px; }
        .color-picker { width: 30px; height: 30px; border: 1px solid var(--crimson); background: none; cursor: pointer; padding: 0; }

        #note-body { min-height: 70vh; color: var(--parchment); font-size: 1.1rem; outline: none; line-height: 1.7; padding-bottom: 250px; }

        .relic-container { display: inline-block; position: relative; margin: 30px 0; border: 1px solid rgba(139,0,0,0.5); min-width: 50px; min-height: 50px; touch-action: none; background: rgba(0,0,0,0.2); }
        .relic-container img { display: block; width: 100%; height: 100%; pointer-events: none; }
        .relic-table { width: 100%; height: 100%; border-collapse: collapse; background: rgba(0,0,0,0.6); table-layout: fixed; }
        .relic-table td { border: 1px solid var(--crimson); padding: 8px; outline: none; color: var(--parchment); font-size: 0.9rem; }
        .table-menu { position: absolute; top: -38px; left: -1px; display: flex; gap: 3px; background: var(--crimson); padding: 5px; border-radius: 4px 4px 0 0; z-index: 110; width: max-content; }
        .drag-handle { background: #fff; color: #000; padding: 2px 6px; font-weight: bold; font-size: 10px; border-radius: 2px; cursor: move; }
        .menu-btn { background: var(--oxblood); border: none; color: white; font-size: 8px; padding: 4px; cursor: pointer; font-family: 'Cinzel'; }
        .resize-handle { position: absolute; bottom: 0; right: 0; width: 25px; height: 25px; cursor: nwse-resize; z-index: 120; display: flex; align-items: flex-end; justify-content: flex-end; padding: 3px; color: var(--crimson); font-weight: bold; font-size: 15px; }

        .modal-overlay { display: none; position: fixed; inset: 0; background: rgba(0,0,0,0.85); z-index: 1001; }
        #folder-modal { display: none; position: fixed; top: 50%; left: 50%; transform: translate(-50%, -50%); background: var(--oxblood); border: 2px solid var(--crimson); padding: 25px; z-index: 1002; width: 90%; max-width: 380px; }
        .folder-option { background: rgba(0,0,0,0.3); padding: 10px; margin: 5px 0; border: 1px solid var(--crimson); cursor: pointer; font-family: 'Cinzel'; font-size: 0.7rem; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-box">
        <h2 style="font-family:'Cinzel'; color:var(--crimson); margin-top:0;">The Blood Seal</h2>
        <input type="email" id="login-email" style="width:100%; margin:10px 0; padding:12px; background:#000; color:#fff; border:1px solid var(--crimson);" placeholder="Email">
        <input type="password" id="login-pass" style="width:100%; margin:10px 0; padding:12px; background:#000; color:#fff; border:1px solid var(--crimson);" placeholder="Password">
        <button class="tool-btn" style="width:100%; background:var(--crimson); padding:15px; margin-top:10px;" onclick="handleLogin()">Unlock Archives</button>
    </div>
</div>

<div class="modal-overlay" id="overlay" onclick="closeModal()"></div>
<div id="folder-modal">
    <h3 style="font-family:'Cinzel'; color:var(--crimson); text-align:center;">Archives</h3>
    <button class="tool-btn" style="width:100%; margin-bottom:15px;" onclick="createNewFolder()">üìú Create New Folder</button>
    <div id="existing-folders-list" style="max-height: 200px; overflow-y: auto;"></div>
    <button class="tool-btn" style="width:100%; margin-top:15px;" onclick="closeModal()">Cancel</button>
</div>

<div class="app-container" id="app">
    <aside id="sidebar">
        <div class="sidebar-item" style="color:var(--crimson); font-weight:bold; justify-content:center;" onclick="startNewNote()">‚ú® NEW NOTE</div>
        <div id="folder-list-sidebar"></div>
        <div class="sidebar-item" style="color:var(--silver); margin-top:auto;" onclick="handleLogout()">üö™ EXIT</div>
    </aside>

    <main id="main-editor">
        <div class="scroll-content">
            <div id="current-path-display">Archives / Current Notes</div>
            <input type="text" id="note-title" placeholder="Untitled...">
            <div class="sub-title-toolbar">
                <button class="tool-btn" onmousedown="event.preventDefault()" onclick="exec('bold')">B</button>
                <button class="tool-btn" onmousedown="event.preventDefault()" onclick="exec('italic')">I</button>
                <button class="tool-btn" onmousedown="event.preventDefault()" onclick="exec('underline')">U</button>
                <input type="color" class="color-picker" onchange="exec('foreColor', this.value)">
                <button class="tool-btn" onmousedown="event.preventDefault()" onclick="addWebLink()">üîó</button>
                <button class="tool-btn" onmousedown="event.preventDefault()" onclick="document.getElementById('imgInput').click()">üì∑</button>
                <button class="tool-btn" onmousedown="event.preventDefault()" onclick="customTable()">üìä</button>
                <button class="tool-btn" style="background:var(--crimson);" onmousedown="event.preventDefault()" onclick="saveQuick()">SAVE</button>
                <button class="tool-btn" onmousedown="event.preventDefault()" onclick="openFolders()">MOVE</button>
                <input type="file" id="imgInput" hidden accept="image/*" onchange="insertImg(event)">
            </div>
            <div id="note-body" contenteditable="true"></div>
        </div>
    </main>
</div>

<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-database.js"></script>
<script src="https://www.gstatic.com/firebasejs/8.10.1/firebase-auth.js"></script>

<script>
    const firebaseConfig = {
        apiKey: "AIzaSyCfLzNKz2vtqbCPFbatVYVzKryUoc9CI3w",
        authDomain: "aidennotes.firebaseapp.com",
        databaseURL: "https://aidennotes-default-rtdb.europe-west1.firebasedatabase.app",
        projectId: "aidennotes",
        storageBucket: "aidennotes.firebasestorage.app",
        messagingSenderId: "375700296601",
        appId: "1:375700296601:web:890c92b813038d4cf0b908"
    };
    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    const auth = firebase.auth();
    let currentEditingId = null;
    let currentFolderName = "Current Notes";

    auth.onAuthStateChanged(u => {
        if(u) {
            document.getElementById('app').style.display = 'flex';
            document.getElementById('login-screen').style.display = 'none';
            initApp();
        } else {
            document.getElementById('app').style.display = 'none';
            document.getElementById('login-screen').style.display = 'flex';
        }
    });

    window.handleLogin = () => {
        const email = document.getElementById('login-email').value;
        const pass = document.getElementById('login-pass').value;
        auth.signInWithEmailAndPassword(email, pass).catch(err => alert(err.message));
    };
    window.handleLogout = () => auth.signOut();

    function exec(cmd, val = null) {
        document.getElementById('note-body').focus();
        document.execCommand(cmd, false, val);
    }

    // --- DRAG/RESIZE ENGINE ---
    let activeTarget = null, startX, startY, startW, startH, isResizing = false;
    document.addEventListener('touchstart', (e) => {
        const container = e.target.closest('.relic-container');
        if (!container) return;
        if (e.target.classList.contains('resize-handle')) {
            isResizing = true; activeTarget = container;
            startX = e.touches[0].clientX; startY = e.touches[0].clientY;
            startW = container.offsetWidth; startH = container.offsetHeight;
            e.preventDefault();
        } else if (e.target.classList.contains('drag-handle') || e.target.tagName === 'IMG') {
            isResizing = false; activeTarget = container;
            startX = e.touches[0].clientX - container.offsetLeft;
            startY = e.touches[0].clientY - container.offsetTop;
        }
    }, {passive: false});

    document.addEventListener('touchmove', (e) => {
        if (!activeTarget) return;
        const t = e.touches[0];
        if (isResizing) {
            activeTarget.style.width = (startW + (t.clientX - startX)) + 'px';
            activeTarget.style.height = (startH + (t.clientY - startY)) + 'px';
        } else {
            activeTarget.style.position = 'relative';
            activeTarget.style.left = (t.clientX - startX) + 'px';
            activeTarget.style.top = (t.clientY - startY) + 'px';
        }
        e.preventDefault();
    }, {passive: false});

    document.addEventListener('touchend', () => { activeTarget = null; });

    // --- DATA HANDLING ---
    function initApp() {
        db.ref().on('value', (snap) => {
            const data = snap.val() || {};
            const notes = data.notes || {};
            const folders = data.folders || {};
            
            // Ensure "Current Notes" always exists as a default
            if (!folders["Current Notes"]) {
                folders["Current Notes"] = { name: "Current Notes", parent: null };
            }

            // Render Sidebar
            const container = document.getElementById('folder-list-sidebar');
            container.innerHTML = "";
            
            Object.keys(folders).forEach(fKey => {
                const f = folders[fKey];
                const safeId = fKey.replace(/\s+/g, '-');
                let html = `
                    <div class="sidebar-item" onclick="toggleFolder('${safeId}')" style="background:rgba(139,0,0,0.1)">
                        <span>üìÅ ${f.name}</span>
                        <div class="actions">
                            <span onclick="event.stopPropagation(); renameFolder('${fKey}')">‚úèÔ∏è</span>
                            <span onclick="event.stopPropagation(); deleteFolder('${fKey}')">üóëÔ∏è</span>
                        </div>
                    </div>
                    <div id="${safeId}" class="folder-content">`;
                
                Object.keys(notes).forEach(nKey => {
                    const n = notes[nKey];
                    // Link note if folder matches OR if it's a "lost" note and this is the default folder
                    if(n.folder === fKey || (!n.folder && fKey === "Current Notes")) {
                        html += `
                            <div class="sidebar-item" style="font-size:0.65rem;">
                                <span onclick="loadNote('${nKey}')">üìú ${n.title || "Untitled"}</span>
                                <div class="actions">
                                    <span onclick="event.stopPropagation(); deleteNote('${nKey}', '${n.title}')">üóëÔ∏è</span>
                                </div>
                            </div>`;
                    }
                });
                html += `</div>`;
                container.innerHTML += html;
            });

            // Render Modal List
            const list = document.getElementById('existing-folders-list');
            list.innerHTML = "";
            Object.keys(folders).forEach(fKey => {
                const div = document.createElement('div');
                div.className = "folder-option"; div.innerText = folders[fKey].name;
                div.onclick = () => {
                    currentFolderName = fKey;
                    document.getElementById('current-path-display').innerText = "Archives / " + fKey;
                    if(currentEditingId) db.ref('notes/'+currentEditingId+'/folder').set(fKey);
                    closeModal();
                };
                list.appendChild(div);
            });
        });
    }

    window.loadNote = (id) => {
        db.ref('notes/'+id).once('value', s => {
            const n = s.val(); 
            if(!n) return;
            currentEditingId = id; 
            currentFolderName = n.folder || "Current Notes";
            document.getElementById('note-title').value = n.title || "";
            document.getElementById('note-body').innerHTML = n.body || "";
            document.getElementById('current-path-display').innerText = "Archives / " + currentFolderName;
        });
    };

    window.saveQuick = () => {
        const data = { 
            title: document.getElementById('note-title').value || "Untitled", 
            body: document.getElementById('note-body').innerHTML, 
            folder: currentFolderName, 
            timestamp: Date.now() 
        };
        if (currentEditingId) db.ref('notes/'+currentEditingId).update(data).then(()=>alert("Saved")); 
        else db.ref('notes').push(data).then(()=>alert("Note Created"));
    };

    window.createNewFolder = () => {
        const name = prompt("Folder Name:");
        if(name) {
            // Push to Firebase folders node
            db.ref('folders/' + name).set({ name: name, parent: null });
        }
        closeModal();
    };

    window.renameFolder = (old) => {
        const n = prompt("New Name:", old);
        if(n && n !== old) {
            db.ref('folders/'+old).once('value', s => {
                db.ref('folders/'+n).set(s.val()); db.ref('folders/'+old).remove();
                db.ref('notes').once('value', snap => {
                    const all = snap.val();
                    for(let id in all) if(all[id].folder === old) db.ref('notes/'+id+'/folder').set(n);
                });
            });
        }
    };

    window.deleteFolder = (n) => { 
        if(n === "Current Notes") { alert("Cannot delete the Prime Archive."); return; }
        if(confirm(`Delete folder ${n}?`)) db.ref('folders/'+n).remove(); 
    };

    window.deleteNote = (id, t) => { if(confirm(`Delete note ${t}?`)) db.ref('notes/'+id).remove(); };
    window.toggleFolder = (id) => { const el = document.getElementById(id); el.style.display = (el.style.display === 'block') ? 'none' : 'block'; };
    window.openFolders = () => { document.getElementById('folder-modal').style.display='block'; document.getElementById('overlay').style.display='block'; };
    window.closeModal = () => { document.getElementById('folder-modal').style.display='none'; document.getElementById('overlay').style.display='none'; };
    window.startNewNote = () => { currentEditingId = null; document.getElementById('note-title').value = ""; document.getElementById('note-body').innerHTML = ""; };

    window.insertImg = (e) => {
        const reader = new FileReader();
        reader.onload = (ev) => {
            const html = `<div class="relic-container" style="width:200px; height:auto;"><img src="${ev.target.result}"><div class="resize-handle">‚åü</div></div><p><br></p>`;
            exec('insertHTML', html);
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    window.customTable = () => {
        const r = prompt("Rows?", "2"), c = prompt("Cols?", "2");
        if(!r || !c) return;
        let t = `<table class="relic-table">`;
        for(let i=0; i<r; i++) { t += `<tr>`; for(let j=0; j<c; j++) t += `<td contenteditable="true">...</td>`; t += `</tr>`; }
        t += `</table>`;
        const html = `<div class="relic-container" style="width:250px; height:100px;"><div class="table-menu"><div class="drag-handle">DRAG</div><button class="menu-btn" onclick="modifyTable(this, 'row')">+R</button><button class="menu-btn" onclick="modifyTable(this, 'col')">+C</button><button class="menu-btn" style="color:red;" onclick="this.closest('.relic-container').remove()">üóëÔ∏è</button></div>${t}<div class="resize-handle">‚åü</div></div><p><br></p>`;
        exec('insertHTML', html);
    };

    window.modifyTable = (btn, action) => {
        const table = btn.closest('.relic-container').querySelector('table');
        if (action === 'row') { const r = table.insertRow(); for(let i=0; i<table.rows[0].cells.length; i++) r.insertCell().contentEditable = "true"; }
        else if (action === 'col') { for(let i=0; i<table.rows.length; i++) table.rows[i].insertCell().contentEditable = "true"; }
    };

    window.addWebLink = () => {
        let url = prompt("URL:", "https://");
        if(url) exec('insertHTML', `<a href="${url}" target="_blank" style="color:var(--crimson);">${url}</a>`);
    };
</script>
</body>
</html>
